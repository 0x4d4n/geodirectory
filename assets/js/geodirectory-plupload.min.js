function geodir_esc_entities(e){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};return String(e).replace(/[&<>"'`=\/]/g,function(e){return a[e]})}function geodir_remove_file_index(e){for(var a=0;a<e.length;a++)e[a].files.length>0&&e[a].removeFile(e[a].files[0])}function plu_show_thumbs(e){var a=parseInt(jQuery("#"+e+"totImg").val()),i=(parseInt(jQuery("#"+e+"image_limit").val()),jQuery),r=i("#"+e+"plupload-thumbs");r.html("");var l=i("#"+e,i("#"+e+"plupload-upload-ui").parent()).val();if(void 0!==geodir_params.action_remove&&""!=geodir_params.action_remove&&geodir_params.action_remove,l){for(var t=l.split("::"),o=0;o<t.length;o++)if(t[o]&&"null"!=t[o]){var d=t[o].split("|"),s=d[0],p=d[1],u=d[2],n=d[3],m="",_="";void 0===p&&(p=""),void 0===u&&(u=""),void 0===n&&(n=""),u=geodir_esc_entities(u),n=geodir_esc_entities(n);var g=s.substring(s.lastIndexOf(".")+1);(g=g.split("?").shift())&&(g=g.toLowerCase());var f=s.lastIndexOf("/")+1,c=s.lastIndexOf(".");if(c<f)continue;var v=s.substr(f,c<f?loc.length:c),h="",y="";if("jpg"==g||"jpe"==g||"jpeg"==g||"png"==g||"gif"==g||"bmp"==g||"ico"==g)h='<img class="gd-file-info" data-id="'+p+'" data-title="'+u+'" data-caption="'+n+'" data-src="'+s+'" src="'+s+'" alt=""  />',u.trim()&&(m='<span class="gd-title-preview">'+u+"</span>"),n.trim()&&(_='<span class="gd-caption-preview">'+n+"</span>");else{var b="fa-file";"pdf"==g?b="fa-file-pdf":"zip"==g||"tar"==g?b="fa-file-archive":"doc"==g||"odt"==g?b="fa-file-word":"txt"==g||"text"==g?b="fa-file-text":"csv"==g||"ods"==g||"ots"==g?b="fa-file-excel":"avi"!=g&&"mp4"!=g&&"mov"!=g||(b="fa-file-video"),y="file-thumb",h='<i title="'+v+'" class="fa '+b+' gd-file-info" data-id="'+p+'" data-title="'+u+'" data-caption="'+n+'" data-src="'+s+'" aria-hidden="true"></i>'}var j=i('<div class="thumb '+y+'" id="thumb'+e+o+'">'+m+h+_+'<div class="gd-thumb-actions"><span class="thumbeditlink" onclick="gd_edit_image_meta('+e+","+o+');"><i class="far fa-edit" aria-hidden="true"></i></span><span class="thumbremovelink" id="thumbremovelink'+e+o+'"><i class="fas fa-trash-alt" aria-hidden="true"></i></span></div></div>');r.append(j),j.find(".thumbremovelink").click(function(){jQuery("#"+e+"plupload-upload-ui").hasClass("plupload-upload-uic-multiple")&&(a--,jQuery("#"+e+"totImg").val(a)),jQuery("#"+e+"upload-error").html(""),jQuery("#"+e+"upload-error").removeClass("upload-error");var r=i(this).attr("id").replace("thumbremovelink"+e,"");r=parseInt(r);var o=[];l=i("#"+e,i("#"+e+"plupload-upload-ui").parent()).val(),t=l.split("::");for(var d=0;d<t.length;d++)d!=r&&(o[o.length]=t[d]);return i("#"+e,i("#"+e+"plupload-upload-ui").parent()).val(o.join("::")),plu_show_thumbs(e),!1})}t.length>1&&(r.sortable({update:function(a,l){var t=[];r.find(".gd-file-info").each(function(){t[t.length]=i(this).data("src")+"|"+i(this).data("id")+"|"+i(this).data("title")+"|"+i(this).data("caption"),i("#"+e,i("#"+e+"plupload-upload-ui").parent()).val(t.join("::")),plu_show_thumbs(e)})}}),r.disableSelection());var Q=[];r.find(".gd-file-info").each(function(){Q[Q.length]=i(this).data("src")+"|"+i(this).data("id")+"|"+i(this).data("title")+"|"+i(this).data("caption"),i("#"+e,i("#"+e+"plupload-upload-ui").parent()).val(Q.join("::"))})}}function gd_edit_image_meta(e,a){var i=jQuery("#"+e.id,jQuery("#"+e.id+"plupload-upload-ui").parent()).val().split("::")[a].split("|"),r=geodir_esc_entities(i[2]),l=geodir_esc_entities(i[3]),t="";t=(t=(t=t+"<div class='gd-modal-text'><label for='gd-image-meta-title'>"+geodir_params.label_title+"</label><input id='gd-image-meta-title' value='"+r+"'></div>")+"<div class='gd-modal-text'><label for='gd-image-meta-caption'>"+geodir_params.label_caption+"</label><input id='gd-image-meta-caption' value='"+l+"'></div>")+"<div class='gd-modal-button'><button class='button button-primary button-large' onclick='gd_set_image_meta(\""+e.id+'",'+a+")'>"+geodir_params.button_set+"</button></div>",jQuery("#gd-image-meta-input").html(t),lity("#gd-image-meta-input")}function gd_set_image_meta(e,a){var i=jQuery("#"+e,jQuery("#"+e+"plupload-upload-ui").parent()).val(),r=i.split("::"),l=r[a].split("|"),t=l[0],o=l[1],d=geodir_esc_entities(jQuery("#gd-image-meta-title").val()),s=geodir_esc_entities(jQuery("#gd-image-meta-caption").val());r[a]=t+"|"+o+"|"+d+"|"+s,i=r.join("::"),jQuery("#"+e,jQuery("#"+e+"plupload-upload-ui").parent()).val(i),plu_show_thumbs(e),jQuery("[data-lity-close]",window.parent.document).trigger("click")}jQuery.fn.exists=function(){return jQuery(this).length>0},jQuery(document).ready(function(e){if(e(".plupload-upload-uic").exists()){var a=!1,i="",r="";if(jQuery("#geodirectory-add-post input[name='ID']").length)r=jQuery("#geodirectory-add-post input[name='ID']").val();else r=jQuery("#post input[name='post_ID']").val();e(".plupload-upload-uic").each(function(){var l=e(this),t=l.attr("id").replace("plupload-upload-ui","");plu_show_thumbs(t),(a=JSON.parse(geodir_plupload_params.base_plupload_config)).browse_button=t+a.browse_button,a.container=t+a.container,jQuery("#"+t+"dropbox").length&&(a.drop_element=t+"dropbox"),a.file_data_name=t+a.file_data_name,a.multipart_params.imgid=t,a.multipart_params.post_id=r,l.hasClass("plupload-upload-uic-multiple")&&(a.multi_selection=!0);var o=jQuery("#"+t+"_allowed_types").val();if(o=o&&""!=o?o:"","post_images"==t&&void 0!==geodir_params.gd_allowed_img_types&&""!=geodir_params.gd_allowed_img_types&&(o=geodir_params.gd_allowed_img_types),o&&""!=o){var d=void 0!==geodir_params.txt_all_files&&""!=geodir_params.txt_all_files?geodir_params.txt_all_files:"Allowed files";a.filters=[{title:d,extensions:o}]}var s,p=new plupload.Uploader(a);p.bind("Init",function(e){}),p.bind("Init",function(e,a){if(p.features.dragdrop){var i=jQuery("#"+(t+"dropbox"));i.on("dragenter",function(e){i.addClass("dragover")}),i.on("dragleave",function(e){i.removeClass("dragover")}),i.on("drop",function(){i.removeClass("dragover")})}}),p.init(),p.bind("Error",function(e,a){if(-600==a.code)jQuery("#"+t+"upload-error").addClass("upload-error"),i=(i=void 0!==geodir_params.err_max_file_size&&""!=geodir_params.err_max_file_size?geodir_params.err_max_file_size:"File size error : You tried to upload a file over %s").replace("%s",geodir_plupload_params.upload_img_size),jQuery("#"+t+"upload-error").html(i);else if(-601==a.code){if(jQuery("#"+t+"upload-error").addClass("upload-error"),i=void 0!==geodir_params.err_file_type&&""!=geodir_params.err_file_type?geodir_params.err_file_type:"File type error. Allowed file types: %s","post_images"==t){var r=""!=o?"."+o.replace(/,/g,", ."):"*";i=i.replace("%s",r)}else i=i.replace("%s",jQuery("#"+t+"_allowed_types").attr("data-exts"));jQuery("#"+t+"upload-error").html(i)}else jQuery("#"+t+"upload-error").addClass("upload-error"),jQuery("#"+t+"upload-error").html(a.message)}),p.bind("FilesAdded",function(a,r){var o=parseInt(jQuery("#"+t+"totImg").val()),d=parseInt(jQuery("#"+t+"image_limit").val());if(jQuery("#"+t+"upload-error").html(""),jQuery("#"+t+"upload-error").removeClass("upload-error"),d&&l.hasClass("plupload-upload-uic-multiple")&&d>0){if(o>=d&&d>0){for(;a.files.length>0;)a.removeFile(a.files[0]);return i=(i=void 0!==geodir_params.err_file_upload_limit&&""!=geodir_params.err_file_upload_limit?geodir_params.err_file_upload_limit:"You have reached your upload limit of %s files.").replace("%s",d),jQuery("#"+t+"upload-error").addClass("upload-error"),jQuery("#"+t+"upload-error").html(i),!1}if(a.files.length>d&&d>0){for(;a.files.length>0;)a.removeFile(a.files[0]);return i=(i=void 0!==geodir_params.err_pkg_upload_limit&&""!=geodir_params.err_pkg_upload_limit?geodir_params.err_pkg_upload_limit:"You may only upload %s files with this package, please try again.").replace("%s",d),jQuery("#"+t+"upload-error").addClass("upload-error"),jQuery("#"+t+"upload-error").html(i),!1}}e.each(r,function(e,a){l.find(".filelist").append('<div class="file" id="'+a.id+'"><b>'+a.name+"</b> (<span>"+plupload.formatSize(0)+"</span>/"+plupload.formatSize(a.size)+') <div class="fileprogress"></div></div>')}),a.refresh(),a.start()}),p.bind("UploadProgress",function(a,i){e("#"+i.id+" .fileprogress").width(i.percent+"%"),e("#"+i.id+" span").html(plupload.formatSize(parseInt(i.size*i.percent/100)))});var u=0,n=new Array;p.bind("FileUploaded",function(a,i,r){var o=parseInt(jQuery("#"+t+"totImg").val());if(n[u]=a,clearInterval(s),s=setTimeout(function(){},1e3),u++,e("#"+i.id).fadeOut(),r=r.response,l.hasClass("plupload-upload-uic-multiple")){o++,jQuery("#"+t+"totImg").val(o);var d=e.trim(e("#"+t,e("#"+t+"plupload-upload-ui").parent()).val());d=d?d+"::"+r:r,e("#"+t,e("#"+t+"plupload-upload-ui").parent()).val(d)}else e("#"+t,e("#"+t+"plupload-upload-ui").parent()).val(r+"");plu_show_thumbs(t)})})}});